<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEV | Safe Mode</title>
    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; text-align: center; }
        #console { text-align: left; background: #111; border: 1px solid #333; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 20px; color: #aaa; font-size: 11px; }
        .log-err { color: #ff4757; font-weight: bold; }
        .log-ok { color: #2ecc71; }
        img { max-width: 100%; margin-top: 20px; border: 1px solid #333; display: none; }
        button { background: #ff4757; color: white; padding: 15px; border: none; width: 100%; font-size: 16px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>SAFE MODE DIAGNOSTIC</h1>
    <h2 id="status">INITIALIZING...</h2>
    <div id="card-info" style="color: #2ecc71; font-size: 18px; margin: 10px 0;"></div>
    <img id="card-img" src="" />
    
    <button onclick="copyLogs()">COPY LOGS</button>
    <div id="console">Waiting for logs...</div>

    <script>
        // GLOBAL ERROR CATCHER (Must be first)
        window.onerror = function(msg, url, line) {
            const errBox = document.getElementById('console');
            errBox.innerHTML += `<div class="log-err">⛔ CRITICAL ERROR: ${msg} (Line ${line})</div>`;
            document.getElementById('status').innerText = "CRASHED";
            return false;
        };

        // LOGGER
        function log(msg, type='') {
            const box = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div class="${type}">[${time}] ${msg}</div>`;
            console.log(msg);
        }

        // COPY FUNCTION
        function copyLogs() {
            const txt = document.getElementById('console').innerText;
            navigator.clipboard.writeText(txt).then(() => alert("Logs Copied!"));
        }

        // MAIN LOGIC
        log("System started.");
        
        const params = new URLSearchParams(window.location.search);
        const rawId = params.get('id');
        
        if (!rawId) {
            log("❌ No ID found in URL.", "log-err");
            document.getElementById('status').innerText = "NO ID";
        } else {
            // 1. NORMALIZE ID
            const searchId = decodeURIComponent(rawId).trim().toUpperCase();
            log(`✅ Scanning for ID: ${searchId}`, "log-ok");
            document.getElementById('status').innerText = "LOADING DATA...";

            // 2. FETCH JSON
            fetch('card_data.json')
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then(data => {
                    log(`✅ Database loaded (${data.length} records)`, "log-ok");

                    // 3. FIND CARD
                    const card = data.find(c => String(c['Unique Code']).trim().toUpperCase() === searchId);

                    if (card) {
                        const name = card['Product Name'];
                        log(`✅ Match: ${name}`, "log-ok");
                        document.getElementById('status').innerText = "FETCHING ART...";
                        document.getElementById('card-info').innerText = `${name} - ${card['My Sales Price']}`;

                        // 4. PREPARE API (Handle Special Characters)
                        const cleanName = name.split('(')[0].trim();
                        const cleanNum = String(card['Card Number']).split('/')[0].trim();
                        
                        // SAFE QUERY CONSTRUCTION
                        const query = `name:"${cleanName}" number:"${cleanNum}"`;
                        log(`Query: ${query}`);
                        
                        const apiUrl = `https://api.pokemontcg.io/v2/cards?q=${encodeURIComponent(query)}`;
                        
                        fetch(apiUrl)
                            .then(r => r.json())
                            .then(apiData => {
                                if (apiData.data && apiData.data.length > 0) {
                                    const imgUrl = apiData.data[0].images.large;
                                    document.getElementById('card-img').src = imgUrl;
                                    document.getElementById('card-img').style.display = 'block';
                                    document.getElementById('status').innerText = "READY";
                                    log("✅ Image Loaded", "log-ok");
                                } else {
                                    log("⚠️ No image in TCG database", "log-err");
                                    document.getElementById('status').innerText = "NO IMAGE";
                                }
                            })
                            .catch(e => log(`API Error: ${e.message}`, "log-err"));

                    } else {
                        log(`❌ ID ${searchId} not found in JSON`, "log-err");
                        document.getElementById('status').innerText = "NOT FOUND";
                    }
                })
                .catch(err => {
                    log(`❌ JSON Error: ${err.message}`, "log-err");
                    log("Did you upload card_data.json?", "log-err");
                });
        }
    </script>
</body>
</html>
