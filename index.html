<script>
    const params = new URLSearchParams(window.location.search);
    const cardId = params.get('id');

    fetch('card_data.json')
        .then(res => res.json())
        .then(data => {
            const searchId = decodeURIComponent(cardId).trim();
            const card = data.find(c => String(c['Unique Code']).trim() === searchId);

            if (card) {
                // 1. Fill in the data immediately
                document.getElementById('ui-name').innerText = card['Product Name'];
                document.getElementById('ui-set').innerText = `#${card['Card Number']} | ${card['Set']}`;
                document.getElementById('ui-grade').innerText = `${card['Grade']} | ${card['Card Condition']}`;
                
                const price = (card['My Sales Price'] && card['My Sales Price'] !== "TBD") ? card['My Sales Price'] : card['Suggested Selling Price (Fair Market)'];
                document.getElementById('ui-price').innerText = price;

                // 2. Optimized Image Search
                // This trims everything after a bracket or dash to help the API
                const cleanName = card['Product Name'].split('(')[0].split('-')[0].trim();
                const cardNumber = String(card['Card Number']).trim();
                
                const apiUrl = `https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(cleanName)}" number:"${cardNumber}"`;

                fetch(apiUrl)
                    .then(r => r.json())
                    .then(apiData => {
                        const imgContainer = document.getElementById('img-container');
                        const imgElement = document.getElementById('card-art');

                        if (apiData.data && apiData.data.length > 0) {
                            // Match Found!
                            imgElement.src = apiData.data[0].images.large;
                            imgElement.onload = () => {
                                imgContainer.classList.remove('loading-shimmer');
                                imgElement.style.display = 'block';
                            };
                        } else {
                            // No exact match - Stop shimmering and show fallback
                            imgContainer.classList.remove('loading-shimmer');
                            imgContainer.innerHTML = `<div style="padding:40px; text-align:center; color:#666;">
                                <p>Artwork not found for #${cardNumber}</p>
                                <a href="https://www.tcgplayer.com/search/pokemon/product?q=${encodeURIComponent(cleanName)}" target="_blank" style="color:#2ecc71; text-decoration:none; font-size:12px;">Search TCGPlayer â†’</a>
                            </div>`;
                        }
                    })
                    .catch(() => {
                        document.getElementById('img-container').classList.remove('loading-shimmer');
                        document.getElementById('img-container').innerHTML = "<div>API Offline</div>";
                    });

            } else {
                document.getElementById('ui-name').innerText = "Card Not Found";
            }
        });
</script>
